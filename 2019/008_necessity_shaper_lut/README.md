# Linear のデータに 3DLUTを適用する際は Shaper 1DLUT が必要

## 目的

Linear のデータに 3DLUT を適用する際は Shaper 1DLUT が必要であることを示す。

## 背景

[過去記事](https://trev16.hatenablog.com/entry/2019/06/20/010121)で、自分は以下の記述をした。

> 一般に Linear のデータに対して 3DLUT を適用する場合は、低階調の精度低下を防ぐために Shaper と呼ばれる 1DLUT を適用する。

この **低階調の精度低下** が具体的にどのようなものか、いつものテストパターンで図示したいと思っていた。なので図示する。

## 結論

Linear のデータに対して、とある画像処理(※)をする際に **Shaper 1DLUT + 3DLUT** の組み合わせで変換することで、低階調の精度低下を防ぐことに成功した。結果を図1に示す。

※今回の処理は色域変換(BT.2020 to BT.709)とガンマ補正(1/2.4乗)

図1は上から順に以下の変換となっている。

* 数値計算を利用したLUTを使わない理論通りの変換(Reference画像)
* Shaper 1DLUT + 3DLUT を用いた変換
* 3DLUT のみを用いた変換

3DLUT のみだと低階調で黒つぶれが発生し、理論値からズレていることが分かる。

| 説明 | 図 |
|:---------:|:---------:|
| Reference |  ![r](./blog_img/formula_local.png) |
| Shaper 1DLUT + 3DLUT |  ![s](./blog_img/with_shaper_local.png) |
| 3DLUT Only |  ![o](./blog_img/without_shaper_local.png) |

## 理論

まず、大前提として以下2点の事実がある。

1. 人間の知覚は低輝度領域は敏感であり、高輝度領域は鈍感である[1]
2. (一般的な)3DLUT は低輝度も高輝度も均等に処理する

この事実から、単純に3DLUTのみを適用すると低輝度領域の補間処理で誤差が増大し、結論で述べたような結果をもたらす。これを防ぎ、3DLUT を使いつつも低輝度領域に3DLUTの格子点を多く割り当てる役割を果たすのが Shaper 1DLUT である。

例を1つ挙げる。ガンマ補正の計算は $y = x^{1/2.4}$ の計算式で表現される。そして、人間の視覚特性にマッチするように低輝度領域は変化が急峻で、高輝度領域ほど変化が緩やかな関数となっている。

このガンマ補正を 3DLUT で行う場合に Shaper 1DLUT を利用する場合と、しない場合の格子点間の補間演算のイメージ図を図2に示す。

| 説明 | 図 |
|:---------:|:---------:|
| Shaper 1DLUT + 3DLUT | ![b](./blog_img/graph_3dlut_w_shaper_1dlut.png)  |
| 3DLUT のみ | ![bb](./blog_img/graph_3dlut_only.png) |

Shaper 1DLUT を利用すると、低輝度領域に格子点が密集することになり、視覚的に重要な低輝度領域の計算誤差を下げることができる。

その一方で、表現可能な最低輝度に制限が生じてしまうのだが…それは次の記事で触れる予定である。

## 終わりに

もやもやしていた所か書くことが出来てスッキリした。次はいよいよ本命の Shaper 1DLUT + 3DLUT を用いた ACES Output Transform の実現の検証に戻ろうと思う。

## 参考資料

[1] コンポジゴク, "ガンマについて", http://compojigoku.blog.fc2.com/blog-entry-23.html